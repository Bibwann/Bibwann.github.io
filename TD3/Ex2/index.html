<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>TP3 – Exo 2 : AR géolocalisée (caméra + boussole)</title>
  <style>
    :root { --txt:#f3f3f3; --accent:#16db65; --bg: #000; }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: #000; color: var(--txt); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #wrap { position: fixed; inset: 0; overflow: hidden; }
    #cam { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); /* miroir pour caméra arrière sur certains appareils */ }
    #overlay { position: absolute; inset: 0; pointer-events: none; }
    #hud { position: absolute; inset: 0; }
    .poi { position: absolute; transform: translate(-50%, -50%); min-width: 110px; max-width: 50vw; text-align: center; pointer-events: auto; }
    .poi .tag { display: inline-block; padding: .35rem .55rem; border-radius: 999px; background: rgba(0,0,0,.55); backdrop-filter: blur(6px); border: 1px solid rgba(255,255,255,.15); }
    .poi .name { font-weight: 600; letter-spacing:.2px; }
    .poi .dist { opacity: .9; font-size: .85rem; }
    .poi::after { content: ""; display:block; width:10px; height:10px; margin:.35rem auto 0; border-radius:50%; background: var(--accent); box-shadow: 0 0 12px 2px rgba(22,219,101,.8); }

    #compas { position: absolute; left: 50%; bottom: env(safe-area-inset-bottom, 12px); transform: translateX(-50%); width: min(92vw, 700px); height: 64px; border-radius: 14px; background: rgba(0,0,0,.45); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,.15); overflow: hidden; }
    #rose { position: absolute; top:0; left: 50%; height: 100%; display: flex; align-items: center; gap: 28px; font-variant-numeric: tabular-nums; }
    .tick { opacity:.75; }
    .tick strong { opacity: 1; }
    #cap { position: absolute; inset: 0; border-left: 2px solid var(--accent); transform: translateX(calc(50% - 1px)); }

    #msg { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,.58); border: 1px solid rgba(255,255,255,.15); padding: .5rem .7rem; border-radius: .6rem; font-size:.95rem; text-align:center; max-width: 92vw; }
    #grantBtn { appearance: none; border: 0; padding: .55rem .7rem; border-radius:.5rem; font-weight:600; background: var(--accent); color:#002b11; cursor:pointer; }
  </style>
</head>
<body>
  <div id="wrap">
    <video id="cam" playsinline autoplay muted></video>
    <div id="overlay">
      <div id="hud"></div>
      <div id="compas">
        <div id="rose"></div>
        <div id="cap"></div>
      </div>
      <div id="msg" hidden>
        iOS : autorisez l'accès à l'orientation pour activer la boussole<br/>
        <button id="grantBtn">Autoriser l'orientation</button>
      </div>
    </div>
  </div>

  <script>
    const POIS = [
      { name: "Tour Eiffel", lat: 48.85826, lon: 2.29450 },
      { name: "Notre-Dame", lat: 48.852968, lon: 2.349902 },
      { name: "Arc de Triomphe", lat: 48.8738, lon: 2.2950 },
      { name: "Sacré-Cœur", lat: 48.8867, lon: 2.3431 }
    ];

    const video = document.getElementById('cam');
    const hud = document.getElementById('hud');
    const rose = document.getElementById('rose');
    const msg = document.getElementById('msg');
    const grantBtn = document.getElementById('grantBtn');

    const state = {
      hasCam:false,
      hasGeo:false,
      heading: null,
      pitch: 0,          
      roll: 0,           
      lat: null, lon: null,
      fov: 60,           
    };

    const toRad = d => d * Math.PI / 180;
    const toDeg = r => r * 180 / Math.PI;
    function bearing(fromLat, fromLon, toLat, toLon) {
      const φ1 = toRad(fromLat), φ2 = toRad(toLat);
      const Δλ = toRad(toLon - fromLon);
      const y = Math.sin(Δλ) * Math.cos(φ2);
      const x = Math.cos(φ1)*Math.sin(φ2) - Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
      return (toDeg(Math.atan2(y, x)) + 360) % 360;
    }
    function haversine(fromLat, fromLon, toLat, toLon) {
      const R = 6371000; 
      const dφ = toRad(toLat - fromLat);
      const dλ = toRad(toLon - fromLon);
      const φ1 = toRad(fromLat), φ2 = toRad(toLat);
      const a = Math.sin(dφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(dλ/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
    const norm180 = a => ((a + 540) % 360) - 180;

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } }, audio:false });
        video.srcObject = stream; state.hasCam = true;
      } catch (err) { console.warn('Caméra bloquée:', err); }
    }

    function startGeo() {
      if (!('geolocation' in navigator)) return;
      navigator.geolocation.watchPosition((pos) => {
        state.lat = pos.coords.latitude;
        state.lon = pos.coords.longitude;
        state.hasGeo = true;
      }, (err) => {
        console.warn('Geo KO:', err.message);
      }, { enableHighAccuracy:true, maximumAge: 2000, timeout: 10000 });
    }

    function setupOrientation() {
      const needPerm = typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function';
      if (needPerm) {
        msg.hidden = false;
        grantBtn.onclick = async () => {
          try {
            const res = await DeviceOrientationEvent.requestPermission();
            if (res === 'granted') { msg.hidden = true; window.addEventListener('deviceorientation', onOrient, true); }
          } catch (e) { console.warn(e); }
        };
      } else {
        window.addEventListener('deviceorientationabsolute', onOrient, true);
        window.addEventListener('deviceorientation', onOrient, true);
      }
    }

    function onOrient(e) {
      let heading = e.webkitCompassHeading;
      if (typeof heading !== 'number') {
        const alpha = e.alpha; 
        if (typeof alpha === 'number') {
          const so = screen.orientation && screen.orientation.angle ? screen.orientation.angle : (window.orientation || 0);
          heading = (360 - alpha + so) % 360; 
        }
      }
      if (typeof heading === 'number') state.heading = heading;
      if (typeof e.beta === 'number') state.pitch = e.beta;   
      if (typeof e.gamma === 'number') state.roll = e.gamma;  
    }

    function buildRose() {
      const ticks = [];
      for (let d = -345; d <= 345; d += 15) {
        const label = (d%90===0) ? dirLabel((d+360)%360) : ((d%45===0) ? ((d+360)%360) : '');
        ticks.push(`<span class="tick">${label?`<strong>${label}</strong>`: ((d%30===0)?'·':'')}</span>`);
      }
      rose.innerHTML = ticks.join('');
    }
    function dirLabel(deg) {
      if (deg===0) return 'N'; if (deg===90) return 'E'; if (deg===180) return 'S'; if (deg===270) return 'O';
      return deg;
    }

    function updateRose() {
      if (state.heading==null) return;
      const width = document.getElementById('compas').clientWidth;
      rose.style.transform = `translateX(calc(-50% - ${(state.heading/360)*width}px))`;
    }

    const els = new Map();
    function ensurePOIs() {
      POIS.forEach(p => {
        if (els.has(p)) return;
        const el = document.createElement('div'); el.className = 'poi';
        el.innerHTML = `<div class="tag"><div class="name">${p.name}</div><div class="dist"></div></div>`;
        hud.appendChild(el); els.set(p, el);
      });
    }

    function layoutPOIs() {
      if (!state.hasGeo || state.heading==null) return;
      const W = window.innerWidth, H = window.innerHeight;
      POIS.forEach(p => {
        const brg = bearing(state.lat, state.lon, p.lat, p.lon);      
        const rel = norm180(brg - state.heading);                  
        const visible = Math.abs(rel) <= (state.fov/2);
        const x = (rel / (state.fov/2)) * (W/2) + (W/2);               
        const y = H * (0.5 - (state.pitch || 0)/180 * 0.25); 
        const el = els.get(p);
        if (!el) return;
        el.style.left = `${x}px`; el.style.top = `${y}px`;
        el.style.visibility = visible ? 'visible' : 'hidden';
        const d = haversine(state.lat, state.lon, p.lat, p.lon);
        const unit = d > 1000 ? `${(d/1000).toFixed(1)} km` : `${Math.round(d)} m`;
        el.querySelector('.dist').textContent = unit;
      });
    }

    (async function init(){
      buildRose(); ensurePOIs();
      await startCamera();
      startGeo();
      setupOrientation();
      function tick(){ updateRose(); layoutPOIs(); requestAnimationFrame(tick); }
      tick();
    })();

    window.addEventListener('orientationchange', () => setTimeout(layoutPOIs, 500));
    window.addEventListener('resize', () => layoutPOIs());
  </script>
</body>
</html>
