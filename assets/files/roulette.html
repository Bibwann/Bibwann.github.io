<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VALORANT // PROTOCOL V4.4 (FINAL)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Teko:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');

        :root {
            --val-red: #ff4655;
            --val-dark: #0f1923;
            --val-panel: #1f2b36;
            --val-white: #ece8e1;
            --val-gray: #8b978f;
        }

        * { box-sizing: border-box; user-select: none; outline: none; }
        
        body {
            background-color: var(--val-dark);
            color: var(--val-white);
            font-family: 'Teko', sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        aside {
            width: 260px; height: 100%; background: rgba(15, 25, 35, 0.98);
            border-right: 1px solid rgba(255,255,255,0.1); display: flex;
            flex-direction: column; padding: 20px 0; flex-shrink: 0; z-index: 20;
        }
        .logo {
            font-size: 2.8rem; font-weight: 700; color: var(--val-white);
            text-align: center; margin-bottom: 30px; letter-spacing: 3px;
            border-bottom: 2px solid var(--val-red); padding-bottom: 20px; margin-inline: 20px;
        }
        .logo span { color: var(--val-red); }
        .nav-btn {
            background: transparent; border: none; color: var(--val-gray);
            text-align: left; font-family: 'Teko', sans-serif; font-size: 1.5rem;
            padding: 12px 25px; cursor: pointer; text-transform: uppercase;
            transition: 0.2s; border-left: 4px solid transparent;
            display: flex; align-items: center; gap: 10px; width: 100%;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.05); color: white; padding-left: 30px; }
        .nav-btn.active { 
            color: var(--val-white); border-left: 4px solid var(--val-red);
            background: linear-gradient(90deg, rgba(255,70,85,0.15) 0%, transparent 100%);
        }

        /* --- MAIN --- */
        main {
            flex: 1; position: relative;
            background-image: radial-gradient(circle at top right, #1a2733 0%, #0f1923 60%);
            overflow-y: auto; overflow-x: hidden; padding: 40px;
            display: flex; flex-direction: column; align-items: center; width: 100%;
        }

        .view {
            display: none; width: 100%; max-width: 1200px;
            flex-direction: column; animation: fadeIn 0.4s ease-out; margin: 0 auto;
        }
        .view.active { display: flex; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 { 
            font-size: 3.5rem; margin: 0 0 30px 0; text-transform: uppercase; letter-spacing: 2px;
            border-left: 5px solid var(--val-red); padding-left: 20px; line-height: 1; text-align: left; width: 100%;
        }

        /* --- ROULETTE (IMPROVED) --- */
        .roulette-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 30px; 
            width: 100%; height: 450px; margin-bottom: 30px;
        }
        .visual-card {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
            position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: flex-end; 
            transition: 0.3s; height: 100%;
        }
        .visual-card:hover { border-color: var(--val-red); background: rgba(255,255,255,0.05); }
        
        .card-bg-img {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; transition: 0.1s linear; z-index: 1;
        }
        
        /* AGENT: UTILISATION DU BUSTE (MIEUX CADR√â) */
        .visual-card.agent-box .card-bg-img { 
            object-fit: contain; /* Buste entier visible */
            object-position: bottom center; /* Ancr√© en bas */
            opacity: 1;
            transform: scale(1.1) translateY(10px); /* L√©ger zoom pour remplir */
        }
        
        /* ARME */
        .visual-card.weapon-box .card-bg-img { object-fit: contain; padding: 40px; opacity: 1; }
        
        .card-content { position: relative; z-index: 2; padding: 20px; background: linear-gradient(0deg, rgba(15,25,35,1) 0%, rgba(15,25,35,0.6) 60%, rgba(15,25,35,0) 100%); width: 100%; }
        .card-label { color: var(--val-red); font-size: 1.2rem; letter-spacing: 2px; font-weight: 600; text-transform: uppercase;}
        .card-value { font-size: 3.5rem; font-weight: 700; line-height: 1; text-transform: uppercase; text-shadow: 0 2px 10px black; }

        .action-area { display: flex; justify-content: center; width: 100%; margin-bottom: 30px; }
        .config-panel { background: rgba(15, 25, 35, 0.9); border-top: 2px solid var(--val-red); padding: 30px; width: 100%; margin-top: 20px; }
        
        .chip-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .chip { padding: 5px 15px 5px 5px; background: #2a3b4c; border: 1px solid #3a4b5c; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .chip img { width: 30px; height: 30px; object-fit: contain; }
        .chip:hover { border-color: var(--val-red); }
        .chip.excluded { opacity: 0.4; filter: grayscale(100%); text-decoration: line-through; background: #111; }

        .big-btn {
            background: var(--val-red); color: white; border: none; padding: 15px 60px; font-size: 2rem; font-family: 'Teko', sans-serif; font-weight: 700;
            cursor: pointer; text-transform: uppercase; clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px); transition: 0.2s;
        }
        .big-btn:hover { transform: scale(1.05); }
        .big-btn.win { background: #23a060; } .big-btn.loss { background: #ce303d; }
        /* Disabled state for button during animation */
        .big-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* --- TEAM COMPO GRID --- */
        .compo-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; width: 100%; margin-top: 20px; }
        .compo-card {
            background: var(--val-panel); border-top: 4px solid #555; height: 350px; position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: flex-end; box-shadow: 0 10px 20px rgba(0,0,0,0.4); transition: 0.3s;
        }
        .compo-card:hover { transform: translateY(-5px); border-color: var(--val-red); }
        .compo-card img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; object-position: top center; transition: 0.3s; }
        .compo-card:hover img { transform: scale(1.05); }
        .compo-card .info { position: relative; z-index: 2; padding: 15px; background: linear-gradient(to top, rgba(15,25,35,1) 10%, transparent 100%); text-align: center; }

        /* --- ROSTER / NUZLOCKE GRID (SORTED) --- */
        .roster-section-title { width: 100%; border-bottom: 1px solid #444; color: var(--val-gray); margin: 20px 0 10px 0; padding-bottom: 5px; font-family: 'Roboto Mono'; font-size: 0.9rem; }
        
        .roster-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; width: 100%; }
        
        .roster-card {
            background: var(--val-panel); border: 1px solid #444; border-top-width: 3px;
            height: 120px; position: relative; overflow: hidden; cursor: pointer; transition: 0.2s;
        }
        .roster-card:hover { border-color: white; transform: translateY(-2px); }
        .roster-card img { width: 100%; height: 100%; object-fit: contain; object-position: center bottom; transition: 0.2s; background: radial-gradient(circle, rgba(255,255,255,0.05), transparent); }
        .roster-card:hover img { transform: scale(1.1); }
        .roster-card .name {
            position: absolute; bottom: 0; left: 0; width: 100%; padding: 2px 5px;
            background: rgba(0,0,0,0.8); font-size: 0.9rem; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .roster-card.dead { filter: grayscale(100%); opacity: 0.4; border-color: #333 !important; }
        .roster-card.dead .name { text-decoration: line-through; color: #888; }

        /* Role Colors */
        .role-Duelist { border-color: #f7d663; }
        .role-Initiator { border-color: #89f5d3; }
        .role-Controller { border-color: #ccc; }
        .role-Sentinel { border-color: #ce303d; }

        /* --- LOADING & TOAST --- */
        #loadingScreen { position: fixed; top:0; left:0; width:100%; height:100%; background:#0f1923; z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--val-white); color: var(--val-dark); padding: 15px 30px; font-size: 1.5rem; font-weight: 600; opacity: 0; transition: 0.3s; z-index: 100; }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* --- TRAINING --- */
        .game-area { width: 100%; height: 400px; background: var(--val-panel); border: 2px solid #333; position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .train-menu { display: flex; gap: 15px; margin-bottom: 20px; justify-content: center; width: 100%; }
        .train-btn { background: #1f2b36; border: 1px solid #333; color: white; padding: 10px 20px; cursor: pointer; font-family: 'Teko'; font-size: 1.3rem; }
        .train-btn.active { background: var(--val-red); border-color: var(--val-red); }

        .nuz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #1a1a1a; padding: 15px; border-left: 4px solid var(--val-red); }
        .nuz-current-box { text-align: center; padding: 40px; border: 1px solid rgba(255,255,255,0.1); background: radial-gradient(circle, rgba(255,70,85,0.1) 0%, transparent 70%); margin-bottom: 30px; }
    </style>
</head>
<body>

    <div id="loadingScreen">
        <h1 style="font-size:4rem; margin:0; color:white;">CHARGEMENT...</h1>
        <p style="font-family:'Roboto Mono'; opacity:0.6; color:white;">R√©cup√©ration des bustes agents...</p>
    </div>

    <aside>
        <div class="logo">V // <span>PROTO</span></div>
        <button class="nav-btn active" onclick="nav('roulette')">üé∞ Roulette</button>
        <button class="nav-btn" onclick="nav('teamgen')">üõ°Ô∏è Team Compo</button>
        <button class="nav-btn" onclick="nav('nuzlocke')">üíÄ Nuzlocke</button>
        <button class="nav-btn" onclick="nav('training')">üéØ Entra√Ænement</button>
        <button class="nav-btn" onclick="nav('history')">üìú Historique</button>
    </aside>

    <main>
        <div id="roulette" class="view active">
            <h2>ROULETTE TACTIQUE</h2>
            <div class="roulette-grid">
                <div class="visual-card agent-box">
                    <img id="agentImg" class="card-bg-img" src="" alt="">
                    <div class="card-content">
                        <div class="card-label">AGENT <span id="agentRole" style="color:white; opacity:0.6; margin-left:10px; font-size:0.9rem">...</span></div>
                        <div class="card-value" id="agentDisplay">?</div>
                    </div>
                </div>
                <div class="visual-card weapon-box">
                    <img id="weaponImg" class="card-bg-img" src="" alt="">
                    <div class="card-content">
                        <div class="card-label">ARME</div>
                        <div class="card-value" id="weaponDisplay">?</div>
                    </div>
                </div>
            </div>
            <div class="action-area">
                <button id="spinBtn" class="big-btn" onclick="spinRoulette()">LANCER LE ROUND</button>
            </div>
            <div class="config-panel">
                <div style="color:var(--val-red); font-size:1.8rem; margin-bottom:15px; border-bottom:1px solid #333;">‚ö†Ô∏è FILTRES</div>
                <h4 style="color:var(--val-gray); margin:10px 0;">AGENTS</h4>
                <div class="chip-container" id="agentList"></div>
                <h4 style="color:var(--val-gray); margin:20px 0 10px 0;">ARMES</h4>
                <div class="chip-container" id="weaponList"></div>
            </div>
        </div>

        <div id="teamgen" class="view">
            <h2>G√âN√âRATEUR D'ESCOUADE</h2>
            <button class="big-btn" style="width:100%; margin-bottom:20px;" onclick="generateTeam()">NOUVELLE COMPO</button>
            <div id="teamStratName" style="font-size:1.8rem; color:var(--val-red); text-align:center; margin-bottom:20px;"></div>
            <div class="compo-grid" id="teamGrid"></div>
        </div>

        <div id="nuzlocke" class="view">
            <h2>PROTOCOL: PERMADEATH</h2>
            <div class="nuz-header">
                <div style="font-size:1.5rem;">VIVANTS: <span id="nuzAliveCount" style="color:#23a060; font-weight:bold">0</span></div>
                <div style="font-size:1.5rem;">MORTS: <span id="nuzDeadCount" style="color:var(--val-red); font-weight:bold">0</span></div>
                <button style="background:transparent; border:1px solid #444; color:#888; padding:5px 10px; cursor:pointer;" onclick="resetNuzlocke()">RESET</button>
            </div>

            <div class="nuz-current-box">
                <div style="font-family:'Roboto Mono'; color:var(--val-gray); margin-bottom:10px;">AGENT ACTIF</div>
                <div style="display:flex; justify-content:center; align-items:center; gap:20px; margin-bottom:20px;">
                    <img id="nuzActiveImg" src="" style="width:100px; height:100px; border-radius:50%; border:2px solid var(--val-red); object-fit:cover; display:none;">
                    <div id="nuzActiveAgent" style="font-size:4rem; font-weight:700; line-height:1;">...</div>
                </div>
                <div id="nuzControls" style="display:none; gap:15px; justify-content:center;">
                    <button class="big-btn win" onclick="handleNuzlockeAction('release')">‚ù§Ô∏è LIB√âRER</button>
                    <button class="big-btn loss" onclick="handleNuzlockeAction('kill')">‚ò†Ô∏è D√âC√àS</button>
                </div>
                <div id="nuzStartBtn">
                    <button class="big-btn" onclick="spinNuzlocke()">DRAFTER</button>
                </div>
            </div>

            <h3 style="margin-top:20px;">ROSTER (TRI√â PAR R√îLE)</h3>
            <div id="nuzGrid"></div>
        </div>

        <div id="training" class="view">
            <h2>CENTRE D'ENTRA√éNEMENT</h2>
            <div class="train-menu">
                <button class="train-btn active" onclick="setTrainingMode('reflex')">‚ö° R√âFLEXES</button>
                <button class="train-btn" onclick="setTrainingMode('gridshot')">üéØ GRIDSHOT</button>
                <button class="train-btn" onclick="setTrainingMode('defuse')">üí£ DEFUSE</button>
            </div>
            <div id="gameContainer" class="game-area"></div>
            <div id="gameStats" style="margin-top:20px; font-size:1.5rem; color:var(--val-red);"></div>
        </div>
        <div id="history" class="view">
            <h2>HISTORIQUE</h2>
            <div id="historyList" style="width:100%;"></div>
        </div>
    </main>

    <div id="toast">Notif</div>

    <script>
        let db = { agents: [], weapons: [] };
        
        async function initApp() {
            try {
                // Fetch Agents
                const resA = await fetch('https://valorant-api.com/v1/agents?language=fr-FR&isPlayableCharacter=true');
                const jsonA = await resA.json();
                
                db.agents = jsonA.data.map(a => ({
                    uuid: a.uuid, name: a.displayName,
                    role: a.role ? a.role.displayName : "Unknown",
                    // ON UTILISE LE BUSTE POUR UN MEILLEUR CADRAGE
                    img: a.bustPortrait || a.fullPortrait, 
                    fullImg: a.fullPortrait, // Gard√© pour la team compo (grand)
                    icon: a.displayIcon
                }));

                const resW = await fetch('https://valorant-api.com/v1/weapons?language=fr-FR');
                const jsonW = await resW.json();
                db.weapons = jsonW.data.map(w => ({ name: w.displayName, img: w.displayIcon }));

                if(state.nuzlocke.alive.length === 0 && state.nuzlocke.dead.length === 0) {
                    state.nuzlocke.alive = db.agents.map(a => a.name);
                }

                document.getElementById('loadingScreen').style.display = 'none';
                preloadRoulette();
                renderSettings();
                generateTeam();
                renderNuzlocke();

            } catch (e) {
                document.getElementById('loadingScreen').innerHTML = "<h1>ERREUR CONNEXION</h1>";
            }
        }

        let state = {
            bl_agents: JSON.parse(localStorage.getItem('bl_agents')) || [],
            bl_weapons: JSON.parse(localStorage.getItem('bl_weapons')) || [],
            history: [],
            nuzlocke: JSON.parse(localStorage.getItem('nuzlocke_state')) || { alive: [], dead: [], current: null },
            trainingMode: null
        };

        function nav(id) {
            document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            if(id === 'roulette') renderSettings();
            if(id === 'history') renderHistory();
            if(id === 'nuzlocke') renderNuzlocke();
            if(id === 'training') setTrainingMode('reflex');
        }

        function showToast(msg) {
            const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function preloadRoulette() {
            if(db.agents.length > 0) {
                const a = db.agents[0]; const w = db.weapons[0];
                document.getElementById('agentDisplay').innerText = a.name;
                document.getElementById('agentRole').innerText = a.role;
                document.getElementById('agentImg').src = a.img;
                document.getElementById('weaponDisplay').innerText = w.name;
                document.getElementById('weaponImg').src = w.img;
            }
        }

        // === ROULETTE AVEC ANIMATION DE D√âC√âL√âRATION ===
        function spinRoulette() {
            const poolA = db.agents.filter(a => !state.bl_agents.includes(a.name));
            const poolW = db.weapons.filter(w => !state.bl_weapons.includes(w.name));

            if(poolA.length === 0 || poolW.length === 0) return showToast("‚ö†Ô∏è Tout est banni !");

            const btn = document.getElementById('spinBtn');
            btn.disabled = true;

            const elA = document.getElementById('agentDisplay');
            const imgA = document.getElementById('agentImg');
            const elW = document.getElementById('weaponDisplay');
            const imgW = document.getElementById('weaponImg');
            
            // Animation logic: Fast then slow
            let speed = 50;
            let steps = 0;
            const maxSteps = 30; // Nbr de flashs avant arr√™t

            function step() {
                const rndA = poolA[Math.floor(Math.random()*poolA.length)];
                const rndW = poolW[Math.floor(Math.random()*poolW.length)];
                
                elA.innerText = rndA.name; imgA.src = rndA.img;
                elW.innerText = rndW.name; imgW.src = rndW.img;
                
                steps++;
                
                if(steps < maxSteps) {
                    // Ralentir progressivement √† la fin
                    if(steps > maxSteps - 10) speed += 30; 
                    setTimeout(step, speed);
                } else {
                    // Final Pick
                    const finalA = poolA[Math.floor(Math.random()*poolA.length)];
                    const finalW = poolW[Math.floor(Math.random()*poolW.length)];
                    elA.innerText = finalA.name; document.getElementById('agentRole').innerText = finalA.role; imgA.src = finalA.img;
                    elW.innerText = finalW.name; imgW.src = finalW.img;
                    
                    state.history.unshift({t: new Date().toLocaleTimeString(), a: finalA.name, w: finalW.name});
                    btn.disabled = false;
                }
            }
            step();
        }

        function renderSettings() {
            const al = document.getElementById('agentList'); al.innerHTML = '';
            const wl = document.getElementById('weaponList'); wl.innerHTML = '';
            db.agents.forEach(a => createChip(al, a, 'agent'));
            db.weapons.forEach(w => createChip(wl, w, 'weapon'));
        }

        function createChip(parent, obj, type) {
            const s = document.createElement('div');
            const name = obj.name;
            const list = type === 'agent' ? state.bl_agents : state.bl_weapons;
            const imgUrl = type === 'agent' ? obj.icon : obj.img;
            s.className = `chip ${list.includes(name) ? 'excluded' : ''}`;
            s.innerHTML = `<img src="${imgUrl}">${name}`;
            s.onclick = () => {
                if(list.includes(name)) list.splice(list.indexOf(name), 1); else list.push(name);
                localStorage.setItem(type === 'agent'?'bl_agents':'bl_weapons', JSON.stringify(list));
                renderSettings();
            };
            parent.appendChild(s);
        }

        function generateTeam() {
            let agents = db.agents.sort(()=>0.5-Math.random()).slice(0, 5);
            document.getElementById('teamStratName').innerText = `PROTOCOLE : RANDOM`;
            const grid = document.getElementById('teamGrid'); grid.innerHTML = '';
            
            agents.forEach(a => {
                const roleId = a.role.replace('Contr√¥leur','Controller').replace('Sentinelle','Sentinel').replace('Initiateur','Initiator');
                const d = document.createElement('div');
                d.className = `compo-card role-${roleId}`;
                // Utilise Full IMG pour la compo car carte haute
                d.innerHTML = `
                    <img src="${a.fullImg || a.img}">
                    <div class="info">
                        <div style="font-weight:700; font-size:1.8rem; line-height:1; text-transform:uppercase;">${a.name}</div>
                        <div style="font-size:1rem; opacity:0.8; font-family:'Roboto Mono'">${a.role}</div>
                    </div>`;
                grid.appendChild(d);
            });
        }

        // === NUZLOCKE AVEC TRI PAR R√îLE ===
        function renderNuzlocke() {
            const container = document.getElementById('nuzGrid'); container.innerHTML = '';
            document.getElementById('nuzAliveCount').innerText = state.nuzlocke.alive.length;
            document.getElementById('nuzDeadCount').innerText = state.nuzlocke.dead.length;
            
            const activeDisplay = document.getElementById('nuzActiveAgent');
            const activeImg = document.getElementById('nuzActiveImg');
            
            // Gestion affichage actif
            if(state.nuzlocke.current) {
                const currAgent = db.agents.find(a => a.name === state.nuzlocke.current);
                activeDisplay.innerText = state.nuzlocke.current;
                if(currAgent) { activeImg.src = currAgent.icon; activeImg.style.display = 'block'; }
                document.getElementById('nuzControls').style.display = 'flex';
                document.getElementById('nuzStartBtn').style.display = 'none';
            } else {
                activeDisplay.innerText = "..."; activeImg.style.display = 'none';
                document.getElementById('nuzControls').style.display = 'none';
                document.getElementById('nuzStartBtn').style.display = 'block';
            }

            // --- SORTING LOGIC ---
            // On veut afficher dans l'ordre: Duelist, Initiator, Controller, Sentinel
            const rolesOrder = ["Duelist", "Duelliste", "Initiator", "Initiateur", "Controller", "Contr√¥leur", "Sentinel", "Sentinelle"];
            
            const sortedAgents = db.agents.sort((a, b) => {
                const rA = rolesOrder.indexOf(a.role);
                const rB = rolesOrder.indexOf(b.role);
                // Si r√¥les diff√©rents, trier par l'index du r√¥le, sinon par nom
                return (rA - rB) || a.name.localeCompare(b.name);
            });

            const grid = document.createElement('div');
            grid.className = 'roster-grid';

            sortedAgents.forEach(a => {
                const isDead = state.nuzlocke.dead.includes(a.name);
                // Normaliser role pour CSS
                let roleCss = "Duelist";
                if(a.role.includes("Initi")) roleCss = "Initiator";
                else if(a.role.includes("Control") || a.role.includes("Contr√¥l")) roleCss = "Controller";
                else if(a.role.includes("Sentin")) roleCss = "Sentinel";

                const d = document.createElement('div');
                d.className = `roster-card role-${roleCss} ${isDead ? 'dead' : ''}`;
                d.title = a.role; // Tooltip
                d.onclick = () => toggleManualStatus(a.name);
                // Utilise le Buste pour le roster aussi
                d.innerHTML = `<img src="${a.img}"><div class="name">${a.name}</div>`;
                grid.appendChild(d);
            });
            container.appendChild(grid);
        }

        function spinNuzlocke() {
            if(state.nuzlocke.alive.length === 0) return showToast("GAME OVER !");
            const disp = document.getElementById('nuzActiveAgent');
            let count = 0;
            const interval = setInterval(() => {
                const r = state.nuzlocke.alive[Math.floor(Math.random()*state.nuzlocke.alive.length)];
                disp.innerText = r; count++;
                if(count > 10) {
                    clearInterval(interval);
                    state.nuzlocke.current = r;
                    saveNuzlocke(); renderNuzlocke();
                }
            }, 80);
        }

        function handleNuzlockeAction(action) {
            const agent = state.nuzlocke.current; if(!agent) return;
            if(action === 'kill') { state.nuzlocke.alive = state.nuzlocke.alive.filter(a => a !== agent); state.nuzlocke.dead.push(agent); }
            state.nuzlocke.current = null; saveNuzlocke(); renderNuzlocke();
        }

        function toggleManualStatus(name) {
            const isDead = state.nuzlocke.dead.includes(name);
            if(confirm(isDead ? `Ressusciter ${name} ?` : `Tuer ${name} ?`)) {
                if(isDead) { state.nuzlocke.dead = state.nuzlocke.dead.filter(n => n !== name); if(!state.nuzlocke.alive.includes(name)) state.nuzlocke.alive.push(name); } 
                else { state.nuzlocke.alive = state.nuzlocke.alive.filter(n => n !== name); if(!state.nuzlocke.dead.includes(name)) state.nuzlocke.dead.push(name); if(state.nuzlocke.current === name) state.nuzlocke.current = null; }
                saveNuzlocke(); renderNuzlocke();
            }
        }
        function resetNuzlocke() { if(confirm("Reset ?")) { state.nuzlocke = { alive: db.agents.map(a => a.name), dead: [], current: null }; saveNuzlocke(); renderNuzlocke(); } }
        function saveNuzlocke() { localStorage.setItem('nuzlocke_state', JSON.stringify(state.nuzlocke)); }

        // === TRAINING & HISTORY ===
        let gameTimer, gameActive = false, score = 0;
        function setTrainingMode(mode) {
            state.trainingMode = mode;
            document.querySelectorAll('.train-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`button[onclick="setTrainingMode('${mode}')"]`).classList.add('active');
            const c = document.getElementById('gameContainer'); c.innerHTML = '';
            clearInterval(gameTimer); gameActive = false;
            
            if(mode === 'reflex') {
                c.innerHTML = `<div id="reflexBox" style="width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;cursor:pointer;"><div style="font-size:3rem;">START</div><div>Attends le vert...</div></div>`;
                const b = document.getElementById('reflexBox');
                let st='idle', startT;
                b.onmousedown = () => {
                    if(st==='idle' || st==='res'){ st='wait'; b.style.background='#ce303d'; b.firstChild.innerText='...'; gameTimer=setTimeout(()=>{st='now';startT=Date.now();b.style.background='#23a060';b.firstChild.innerText='CLIQUE !';}, 2000+Math.random()*3000); }
                    else if(st==='wait'){ clearTimeout(gameTimer); st='res'; b.style.background=''; b.firstChild.innerText='TROP T√îT'; }
                    else if(st==='now'){ const ms=Date.now()-startT; st='res'; b.style.background=''; b.firstChild.innerText=ms+'ms'; }
                };
            }
            if(mode === 'gridshot') c.innerHTML = `<button class="big-btn" onclick="startGridshot()">START 30s</button>`;
            if(mode === 'defuse') c.innerHTML = `<button class="big-btn" onclick="startDefuse()">START DEFUSE</button>`;
        }
        function startGridshot(){ 
            const p=document.getElementById('gameContainer'); p.innerHTML=''; score=0; let t=30;
            const spawn=()=>{ if(t<=0)return; const e=document.createElement('div'); e.style.cssText="position:absolute;width:60px;height:60px;border-radius:50%;background:radial-gradient(circle,#0ff 0%,#00f 100%);border:2px solid white;cursor:crosshair;"; e.style.top=Math.random()*(340)+'px'; e.style.left=Math.random()*(p.clientWidth-60)+'px'; e.onmousedown=(ev)=>{ev.stopPropagation();score++;e.remove();spawn();document.getElementById('gameStats').innerText='SCORE: '+score;}; p.appendChild(e); };
            spawn();
            gameTimer=setInterval(()=>{t--;if(t<=0){clearInterval(gameTimer);p.innerHTML=`<div style="font-size:3rem">SCORE: ${score}</div><button class="big-btn" onclick="startGridshot()">RETRY</button>`;}},1000);
        }
        function startDefuse(){
            gameActive=true; const seq=[]; for(let i=0;i<8;i++)seq.push(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'][Math.floor(Math.random()*4)]);
            let idx=0, html='<div style="margin-bottom:20px; font-size:3rem;">'; seq.forEach((k,i)=>html+=`<span id="a-${i}" style="margin:0 10px; color:#555;">${k==='ArrowUp'?'‚¨ÜÔ∏è':k==='ArrowDown'?'‚¨áÔ∏è':k==='ArrowLeft'?'‚¨ÖÔ∏è':'‚û°Ô∏è'}</span>`);
            document.getElementById('gameContainer').innerHTML = html + '</div><div>TAPPE LES FL√àCHES VITE !</div>';
            let t=4.0; 
            gameTimer=setInterval(()=>{t=(t-0.1).toFixed(1);document.getElementById('gameStats').innerText=`BOOM: ${t}s`;if(t<=0)endDefuse(false);},100);
            window.onkeydown=(e)=>{
                if(state.trainingMode!=='defuse'||!gameActive)return;
                if(e.key===seq[idx]){ document.getElementById(`a-${idx}`).style.color='#0f0'; idx++; if(idx>=8)endDefuse(true); }
                else if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){ endDefuse(false); }
            };
        }
        function endDefuse(w){ gameActive=false; clearInterval(gameTimer); document.getElementById('gameContainer').innerHTML=w?`<div style="color:#0f0;font-size:3rem">DEFUSED!</div><button class="big-btn" onclick="startDefuse()">AGAIN</button>`:`<div style="color:red;font-size:3rem">BOOM!</div><button class="big-btn" onclick="startDefuse()">RETRY</button>`; }

        function renderHistory() {
            const h = document.getElementById('historyList'); h.innerHTML = '';
            state.history.forEach(i => {
                const r = document.createElement('div');
                r.style = "padding:15px; border-bottom:1px solid #333; display:flex; justify-content:space-between;";
                r.innerHTML = `<div><span style="color:var(--val-red);font-weight:bold">${i.a}</span> + ${i.w}</div><div style="opacity:0.6">${i.t}</div>`;
                h.appendChild(r);
            });
        }

        initApp();
        setTrainingMode('reflex');
    </script>
</body>
</html>